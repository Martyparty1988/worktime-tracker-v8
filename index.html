```html
<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <!-- Vylepšený název s novou funkcí -->
    <title>WorkTime Tracker v7.1 (€) - Stoly</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #0c0d12; color: #e5e7eb; }
        .app-container { max-width: 450px; }
        .glow-main { box-shadow: 0 0 10px rgba(79, 70, 229, 0.3); } /* Indigo glow */
        .btn-primary { 
            background-color: #4f46e5; /* Indigo */
            color: #ffffff; 
            font-weight: 700; 
            transition: all 0.2s; 
        }
        .btn-primary:hover { background-color: #4338ca; }
        .btn-primary:active { transform: scale(0.98); }
        
        .btn-secondary { 
            background-color: #1f2937; /* Darker slate */
            border: 1px solid #374151; 
            color: #d1d5db;
            transition: background-color 0.2s; 
        }
        .btn-secondary:hover { background-color: #374151; }
        
        input[type="text"], input[type="number"], input[type="datetime-local"], select { 
            background-color: #1f2937; 
            border: 1px solid #374151; 
            color: #e5e7eb; 
            padding: 10px 14px; 
            border-radius: 8px;
            transition: border-color 0.2s;
        }
        input:focus, select:focus { border-color: #4f46e5; outline: none; box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.5); }
        /* Oprava pro vzhled datetime-local v tmavém režimu */
        input[type="datetime-local"]::-webkit-calendar-picker-indicator {
            background-color: #9ca3af;
            border-radius: 2px;
        }

        .tab-active { 
            background-color: #1f2937; 
            border-bottom: 2px solid #4f46e5; 
            color: #e5e7eb;
        }
        /* Mobile usability focus */
        .large-touch-target { min-height: 48px; }

        /* Progress Bar Styling */
        .progress-bar { height: 10px; background-color: #374151; border-radius: 5px; overflow: hidden; }
        .progress-fill { background-color: #4f46e5; transition: width 0.5s ease-in-out; }
    </style>
    <!-- PWA Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="WorkTime €">
    <meta name="theme-color" content="#0c0d12">
</head>
<body class="p-4 flex justify-center large-touch-target">
    <div id="app" class="app-container w-full">
        
        <!-- Header -->
        <header class="mb-8 text-center">
            <!-- Název verze aktualizován -->
            <h1 class="text-4xl font-extrabold text-[#4f46e5] glow-main large-touch-target">WorkTime v7.1</h1>
            <p class="text-sm text-gray-400">Sledování výkonu s kategoriemi a cíli | Měna: EUR (€)</p>
        </header>

        <!-- Loader/Auth Status -->
        <div id="loading-indicator" class="text-center p-4 bg-[#1f2937] rounded-xl mb-4 hidden">
            <p class="text-lg">Načítání dat...</p>
        </div>

        <!-- Main Content (Hidden until auth/load) -->
        <div id="main-content" class="hidden">

            <!-- New Entry Form (Card) -->
            <section id="new-entry-form" class="bg-[#111827] p-5 rounded-2xl mb-8 shadow-2xl large-touch-target">
                <h2 class="text-2xl font-bold mb-4 border-b border-gray-700 pb-2">Nová Činnost</h2>
                
                <!-- Type Selection Tabs -->
                <div class="flex large-touch-target mb-4 border border-gray-700 rounded-lg overflow-hidden">
                    <button id="tab-hourly" class="flex-1 py-3 text-sm font-semibold tab-active" onclick="switchEntryType('hourly')">
                        Hodinová Práce
                    </button>
                    <button id="tab-task" class="flex-1 py-3 text-sm font-semibold" onclick="switchEntryType('task')">
                        Úkolová Práce
                    </button>
                </div>

                <!-- Shared Category Input -->
                <div class="mb-4">
                    <label for="entry-category" class="block text-sm font-medium mb-1 text-gray-400">Kategorie / Projekt:</label>
                    <select id="entry-category" class="w-full large-touch-target">
                        <!-- Kategorie načteny z JS -->
                    </select>
                </div>

                <!-- Hourly Entry Form -->
                <div id="form-hourly">
                    <div class="flex justify-between items-center mb-4 p-3 bg-gray-800 rounded-lg">
                        <span class="text-sm font-medium text-gray-400">Stav:</span>
                        <div id="timer-status" class="flex items-center text-2xl font-mono font-bold">
                            <span class="mr-2 text-yellow-400">STOP</span>
                            <span id="timer-display">00:00:00</span>
                        </div>
                    </div>
                    
                    <button id="start-stop-button" class="w-full large-touch-target py-3 rounded-xl btn-primary mb-3 shadow-lg" onclick="toggleTimer()">
                        ZAHÁJIT PRÁCI
                    </button>

                    <p id="current-session" class="text-xs text-gray-500 text-center">Poslední relace: -</p>
                </div>

                <!-- ZMĚNA: Task Entry Form -->
                <div id="form-task" class="hidden space-y-4">
                    <div>
                        <label for="task-type" class="block text-sm font-medium mb-1 text-gray-400">Typ Stolu:</label>
                        <select id="task-type" class="w-full large-touch-target">
                            <option value="maly">Malý stůl (30 €)</option>
                            <option value="stredni">Střední stůl (48 €)</option>
                            <option value="velky">Velký stůl (60 €)</option>
                        </select>
                    </div>

                    <button class="w-full large-touch-target py-3 rounded-xl btn-primary shadow-lg" onclick="saveTaskEntry()">
                        ULOŽIT ÚKOL
                    </button>
                </div>

            </section>
            
            <!-- Summary & Goal -->
            <section class="bg-[#1f2937] p-5 rounded-2xl mb-8 shadow-xl large-touch-target">
                <!-- Změna: Přidán název měsíce a roku do přehledu -->
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold">Přehled</h2>
                    <span id="summary-date-display" class="text-sm font-semibold text-indigo-400">Leden 2025</span>
                </div>
                
                <!-- Earnings Summary -->
                <div class="flex justify-between items-end mb-4 border-b border-gray-700 pb-3">
                    <span class="text-gray-400 text-sm">Výdělek (vč. běžícího):</span>
                    <span id="total-earnings" class="text-3xl font-extrabold text-[#818cf8] font-mono">0.00 €</span>
                </div>
                
                <!-- Goal Tracking -->
                <div class="space-y-3">
                    <div class="flex justify-between text-sm font-semibold">
                        <span class="text-gray-400">Měsíční Cíl (€):</span>
                        <span id="goal-display" class="text-indigo-400">500.00 €</span>
                    </div>
                    
                    <div class="progress-bar">
                        <div id="goal-progress" class="progress-fill h-full" style="width: 0%;"></div>
                    </div>
                    <p id="goal-progress-text" class="text-sm text-center text-gray-400">0% hotovo</p>
                </div>
                
                <div class="flex justify-between mt-4">
                    <div class="text-center">
                        <p class="text-gray-500 text-xs">Celkem Času (min):</p>
                        <p id="total-time" class="font-bold text-lg text-green-400">0</p>
                    </div>
                    <div class="text-center">
                        <p class="text-gray-500 text-xs">Zbývá do Cíle (€):</p>
                        <p id="remaining-goal" class="font-bold text-lg text-red-400">500.00 €</p>
                    </div>
                </div>
            </section>

            <!-- Entries List with Filters -->
            <section class="mb-8">
                <h2 class="text-2xl font-bold mb-4">Záznamy <span id="user-display" class="text-sm text-gray-500"></span></h2>
                
                <!-- Vylepšené filtry s datem -->
                <div class="grid grid-cols-2 gap-2 mb-4">
                    <select id="filter-month" class="w-full py-2 text-sm large-touch-target" onchange="updateFilters()">
                        <!-- Měsíce doplní JS -->
                    </select>
                    <select id="filter-year" class="w-full py-2 text-sm large-touch-target" onchange="updateFilters()">
                        <!-- Roky doplní JS -->
                    </select>
                    <select id="filter-type" class="w-full py-2 text-sm large-touch-target" onchange="updateFilters()">
                        <option value="all">Typ: Vše</option>
                        <option value="hourly">Typ: Hodinová</option>
                        <option value="task">Typ: Úkolová</option>
                    </select>
                    <select id="filter-category" class="w-full py-2 text-sm large-touch-target" onchange="updateFilters()">
                        <option value="all">Projekt: Vše</option>
                        <!-- Kategorie doplní JS -->
                    </select>
                </div>

                <div id="entries-list" class="space-y-3">
                    <!-- Entries will be injected here -->
                    <p id="no-entries" class="text-gray-500 text-center p-4 large-touch-target">Žádné záznamy k zobrazení.</p>
                </div>
            </section>

            <!-- Settings and Actions -->
            <section class="bg-[#111827] p-5 rounded-2xl mb-6 shadow-xl large-touch-target">
                <h2 class="text-xl font-bold mb-4 border-b border-gray-700 pb-2">Nastavení</h2>
                
                <!-- Hourly Rate Setting -->
                <div class="mb-4">
                    <label for="hourly-rate" class="block text-sm font-medium mb-1 text-gray-400">Hodinová Sazba (€/h):</label>
                    <div class="flex space-x-2">
                        <input type="number" id="hourly-rate" value="10.00" min="1" step="0.01" class="flex-1 rounded-lg large-touch-target">
                        <button class="py-2 px-4 rounded-lg btn-secondary large-touch-target" onclick="saveRate()">Uložit</button>
                    </div>
                </div>

                <!-- Monthly Goal Setting -->
                <div class="mb-6">
                    <label for="monthly-goal" class="block text-sm font-medium mb-1 text-gray-400">Měsíční Cíl (€):</label>
                    <div class="flex space-x-2">
                        <input type="number" id="monthly-goal" value="500.00" min="1" step="1" class="flex-1 rounded-lg large-touch-target">
                        <button class="py-2 px-4 rounded-lg btn-secondary large-touch-target" onclick="saveGoal()">Uložit</button>
                    </div>
                </div>

                <!-- Actions -->
                <div class="space-y-3 pt-4 border-t border-gray-700">
                    <!-- Tlačítko pro správu kategorií -->
                    <button class="w-full py-2 rounded-lg btn-secondary large-touch-target" onclick="showCategoryManager()">Správa Kategorií</button>
                    <button class="w-full py-2 rounded-lg btn-secondary large-touch-target" onclick="exportToCSV()">Exportovat do CSV</button>
                    <button class="w-full py-2 rounded-lg bg-red-800 hover:bg-red-700 text-white font-bold large-touch-target" onclick="showConfirmDelete()">Smazat Všechny Záznamy</button>
                </div>
            </section>
        </div>

        <!-- Delete Confirmation Modal -->
        <div id="delete-modal" class="fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center p-4 hidden z-50">
            <div class="bg-[#1f2937] p-6 rounded-xl shadow-2xl w-full max-w-sm border border-gray-700">
                <h3 class="text-xl font-bold mb-4 text-red-400">Potvrdit Smazání</h3>
                <p class="mb-6 text-gray-300">Opravdu chcete smazat VŠECHNY záznamy? Tato akce je nevratná.</p>
                <div class="flex justify-end space-x-3">
                    <button class="py-2 px-4 rounded-lg btn-secondary large-touch-target" onclick="hideConfirmDelete()">Zrušit</button>
                    <button class="py-2 px-4 rounded-lg bg-red-600 hover:bg-red-700 text-white font-bold large-touch-target" onclick="deleteAllEntries()">Smazat</button>
                </div>
            </div>
        </div>
        
        <!-- Category Management Modal -->
        <div id="category-modal" class="fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center p-4 hidden z-50">
            <div class="bg-[#1f2937] p-6 rounded-xl shadow-2xl w-full max-w-sm border border-gray-700">
                <h3 class="text-xl font-bold mb-4 text-indigo-400">Správa Kategorií</h3>
                
                <!-- Add new category -->
                <div class="flex space-x-2 mb-4">
                    <input type="text" id="new-category-name" placeholder="Nový projekt/kategorie" class="flex-1 large-touch-target">
                    <button class="py-2 px-4 rounded-lg btn-primary large-touch-target" onclick="addCategory()">Přidat</button>
                </div>

                <!-- Category list -->
                <div class="space-y-2 max-h-60 overflow-y-auto" id="category-list">
                    <!-- Kategorie budou renderovány zde -->
                </div>

                <div class="flex justify-end mt-6">
                    <button class="py-2 px-4 rounded-lg btn-secondary large-touch-target" onclick="hideCategoryManager()">Zavřít</button>
                </div>
            </div>
        </div>

        <!-- Edit Entry Modal -->
        <div id="edit-modal" class="fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center p-4 hidden z-50">
            <div class="bg-[#1f2937] p-6 rounded-xl shadow-2xl w-full max-w-sm border border-gray-700">
                <h3 class="text-xl font-bold mb-4 text-indigo-400">Upravit Záznam</h3>
                <input type="hidden" id="edit-entry-id">
                
                <div class="space-y-4">
                    <div>
                        <label for="edit-category" class="block text-sm font-medium mb-1 text-gray-400">Kategorie / Projekt:</label>
                        <select id="edit-category" class="w-full large-touch-target"></select>
                    </div>

                    <!-- Hourly Fields -->
                    <div id="edit-form-hourly" class="space-y-4">
                        <div>
                            <label for="edit-start-time" class="block text-sm font-medium mb-1 text-gray-400">Začátek:</label>
                            <input type="datetime-local" id="edit-start-time" class="w-full large-touch-target">
                        </div>
                        <div>
                            <label for="edit-end-time" class="block text-sm font-medium mb-1 text-gray-400">Konec:</label>
                            <input type="datetime-local" id="edit-end-time" class="w-full large-touch-target">
                        </div>
                    </div>

                    <!-- ZMĚNA: Task Fields -->
                    <div id="edit-form-task" class="space-y-4 hidden">
                        <div>
                            <label for="edit-task-type" class="block text-sm font-medium mb-1 text-gray-400">Typ Stolu:</label>
                            <select id="edit-task-type" class="w-full large-touch-target">
                                <option value="maly">Malý stůl (30 €)</option>
                                <option value="stredni">Střední stůl (48 €)</option>
                                <option value="velky">Velký stůl (60 €)</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="flex justify-end space-x-3 mt-6">
                    <button class="py-2 px-4 rounded-lg btn-secondary large-touch-target" onclick="hideEditModal()">Zrušit</button>
                    <button class="py-2 px-4 rounded-lg btn-primary large-touch-target" onclick="saveEntryChanges()">Uložit Změny</button>
                </div>
            </div>
        </div>
        
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, serverTimestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables provided by the environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : { apiKey: "mock-key" };
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        // Set Firebase log level for debugging
        setLogLevel('debug');

        // --- GLOBAL STATE ---
        const DEFAULT_RATE_EUR = 15.00;
        const DEFAULT_GOAL_EUR = 500.00;
        const DEFAULT_CATEGORIES = ['Design', 'Vývoj', 'Schůzky', 'Administrativa', 'Osobní'];
        // Seznam měsíců pro filtry
        const MONTH_NAMES = ['Leden', 'Únor', 'Březen', 'Duben', 'Květen', 'Červen', 'Červenec', 'Srpen', 'Září', 'Říjen', 'Listopad', 'Prosinec'];
        
        // ZMĚNA: Přidán objekt pro typy stolů
        const TASK_TYPES = {
            'maly': { name: 'Malý stůl', earnings: 30 },
            'stredni': { name: 'Střední stůl', earnings: 48 },
            'velky': { name: 'Velký stůl', earnings: 60 }
        };

        let state = {
            currentUser: null,
            timerStartTime: null, // Timestamp when timer was started
            entries: [], // Array of { id, user, type: 'hourly'|'task', category, startTime, endTime, duration, taskName, taskEarnings }
            settings: {
                userRates: {}, // { userId: rateInEUR }
                monthlyGoal: DEFAULT_GOAL_EUR,
                categories: DEFAULT_CATEGORIES
            },
            entryType: 'hourly', // 'hourly' or 'task'
            // Vylepšený stav filtrů
            filters: {
                type: 'all',
                category: 'all',
                month: new Date().getMonth() + 1, // Current month (1-12)
                year: new Date().getFullYear() // Current year
            }
        };

        let timerInterval = null;

        // --- FIREBASE PATHS AND FUNCTIONS ---
        // Nyní vytváříme cestu dynamicky, když známe ID uživatele

        /**
         * Saves the current state (entries and settings) to Firestore.
         */
        async function saveState() {
            if (!state.currentUser) return;
            // Používáme dynamickou cestu
            const docRef = doc(db, `/artifacts/${appId}/users/${state.currentUser}/work_tracker_data_v7`, 'user_data');
            
            try {
                // Remove transient data before saving
                const dataToSave = {
                    entries: state.entries,
                    settings: state.settings,
                    timerStartTime: state.timerStartTime,
                    timestamp: serverTimestamp()
                };
                await setDoc(docRef, dataToSave);
            } catch (error) {
                console.error("Chyba při ukládání stavu do Firestore:", error);
            }
        }

        /**
         * Listens for real-time updates from Firestore.
         */
        function setupFirestoreListener() {
            if (!state.currentUser) return;
            // Používáme dynamickou cestu
            const docRef = doc(db, `/artifacts/${appId}/users/${state.currentUser}/work_tracker_data_v7`, 'user_data');
            
            onSnapshot(docRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    
                    // Merge incoming data with current state
                    state.entries = data.entries || [];
                    
                    // Handle potential missing sub-properties in settings
                    state.settings.userRates = data.settings?.userRates || { [state.currentUser]: DEFAULT_RATE_EUR };
                    state.settings.monthlyGoal = data.settings?.monthlyGoal || DEFAULT_GOAL_EUR;
                    // Zajistíme, že kategorie jsou vždy pole, i když v DB chybí
                    state.settings.categories = Array.isArray(data.settings?.categories) ? data.settings.categories : DEFAULT_CATEGORIES;

                    state.timerStartTime = data.timerStartTime || null;
                } else {
                    console.log("Žádná data v databázi, inicializuji výchozí stav.");
                    state.entries = [];
                    state.settings.userRates = { [state.currentUser]: DEFAULT_RATE_EUR };
                    state.settings.monthlyGoal = DEFAULT_GOAL_EUR;
                    state.settings.categories = DEFAULT_CATEGORIES;
                    // Uložíme výchozí stav, aby byl v DB
                    saveState(); 
                }
                
                // After fetching/initializing state, update UI
                renderUI();
                startTimerDisplay(); // Re-activate timer interval if needed
            }, (error) => {
                console.error("Chyba při real-time naslouchání Firestore:", error);
            });
        }

        // --- AUTHENTICATION & INITIALIZATION ---

        onAuthStateChanged(auth, async (user) => {
            document.getElementById('loading-indicator').classList.add('hidden');
            document.getElementById('main-content').classList.remove('hidden');

            if (user) {
                state.currentUser = user.uid;
                document.getElementById('user-display').textContent = `(ID: ${state.currentUser.substring(0, 8)}...)`;
                setupFirestoreListener(); // Start listening for data
            } else {
                console.log("Uživatel není přihlášen. Přihlašuji anonymně.");
                await signInAnonymously(auth);
            }
        });

        async function initAuth() {
            try {
                document.getElementById('loading-indicator').classList.remove('hidden');
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Chyba při inicializaci autentizace:", error);
                document.getElementById('loading-indicator').innerHTML = '<p class="text-red-500">Chyba autentizace. Zkuste prosím znovu.</p>';
            }
        }

        // --- CORE LOGIC ---
        
        function vibrate(duration = 10) {
            if ('vibrate' in navigator) {
                navigator.vibrate(duration);
            }
        }

        window.switchEntryType = function(type) {
            vibrate();
            state.entryType = type;
            const hourlyForm = document.getElementById('form-hourly');
            const taskForm = document.getElementById('form-task');
            const tabHourly = document.getElementById('tab-hourly');
            const tabTask = document.getElementById('tab-task');

            // Reset tab classes
            tabHourly.classList.remove('tab-active');
            tabTask.classList.remove('tab-active');

            if (type === 'hourly') {
                hourlyForm.classList.remove('hidden');
                taskForm.classList.add('hidden');
                tabHourly.classList.add('tab-active');
            } else {
                hourlyForm.classList.add('hidden');
                taskForm.classList.remove('hidden');
                tabTask.classList.add('tab-active');
            }
        }

        function getUserRate() {
            return state.settings.userRates[state.currentUser] || DEFAULT_RATE_EUR;
        }

        window.toggleTimer = function() {
            vibrate(50);
            const selectedCategory = document.getElementById('entry-category').value;
            
            // Zkontrolujeme, zda je vybrána kategorie
            if (!selectedCategory && !state.timerStartTime) {
                 console.error("Vyberte prosím kategorii před zahájením práce.");
                 // Můžeme přidat vizuální zpětnou vazbu
                 const categorySelect = document.getElementById('entry-category');
                 categorySelect.classList.add('border-red-500', 'animate-pulse');
                 setTimeout(() => categorySelect.classList.remove('border-red-500', 'animate-pulse'), 1000);
                 return;
            }

            if (state.timerStartTime) {
                // Stop the timer
                const now = Date.now();
                const duration = now - state.timerStartTime;
                
                // Místo pushnutí nového záznamu, najdeme dočasný a aktualizujeme ho
                const runningEntryIndex = state.entries.findIndex(e => e.startTime === state.timerStartTime && e.endTime === null);

                if (runningEntryIndex !== -1) {
                    state.entries[runningEntryIndex].endTime = now;
                    state.entries[runningEntryIndex].duration = duration;
                    state.entries[runningEntryIndex].timestamp = now; // Timestamp pro třídění
                } else {
                    // Pojistka, pokud by dočasný záznam neexistoval (nemělo by nastat)
                    state.entries.push({
                        id: crypto.randomUUID(),
                        user: state.currentUser,
                        type: 'hourly',
                        category: selectedCategory, // Kategorie z momentu startu
                        startTime: state.timerStartTime,
                        endTime: now,
                        duration: duration,
                        timestamp: now
                    });
                }

                state.timerStartTime = null;
                clearInterval(timerInterval);
                timerInterval = null;
            } else {
                // Start the timer
                state.timerStartTime = Date.now();
                
                // Přidáme dočasný záznam do pole, aby se hned zobrazil v UI
                // a aby se mu přiřadila správná kategorie
                state.entries.push({
                    id: crypto.randomUUID(),
                    user: state.currentUser,
                    type: 'hourly',
                    category: selectedCategory,
                    startTime: state.timerStartTime,
                    endTime: null, // null značí běžící
                    duration: 0,
                    timestamp: state.timerStartTime
                });

                startTimerDisplay();
            }
            saveState(); 
            renderUI(); 
        }
        
        // ZMĚNA: Ukládání úkolu (stolu)
        window.saveTaskEntry = function() {
            vibrate(50);
            const taskType = document.getElementById('task-type').value;
            const selectedCategory = document.getElementById('entry-category').value;
            
            const taskDetails = TASK_TYPES[taskType];

            if (!taskDetails || !selectedCategory) {
                console.error("Neplatné zadání: Typ stolu nebo kategorie chybí.");
                // Vizuální zpětná vazba na kategorii, pokud chybí
                if (!selectedCategory) {
                     const categorySelect = document.getElementById('entry-category');
                     categorySelect.classList.add('border-red-500', 'animate-pulse');
                     setTimeout(() => categorySelect.classList.remove('border-red-500', 'animate-pulse'), 1000);
                }
                return;
            }

            state.entries.push({
                id: crypto.randomUUID(),
                user: state.currentUser,
                type: 'task',
                category: selectedCategory,
                taskName: taskDetails.name,
                taskEarnings: taskDetails.earnings,
                timestamp: Date.now()
            });
            
            saveState();
            renderUI();
        }

        window.deleteEntry = function(id) {
            vibrate(30);
            state.entries = state.entries.filter(e => e.id !== id);
            saveState();
            renderUI();
        }

        window.saveRate = function() {
            vibrate(30);
            const rateInput = document.getElementById('hourly-rate');
            const newRate = parseFloat(rateInput.value);

            if (isNaN(newRate) || newRate <= 0) {
                rateInput.value = getUserRate().toFixed(2);
                return;
            }

            if (!state.settings.userRates) { state.settings.userRates = {}; }
            state.settings.userRates[state.currentUser] = newRate;
            
            // Persist settings changes
            saveState();
            renderUI();
        }
        
        window.saveGoal = function() {
            vibrate(30);
            const goalInput = document.getElementById('monthly-goal');
            const newGoal = parseFloat(goalInput.value);

            if (isNaN(newGoal) || newGoal <= 0) {
                goalInput.value = state.settings.monthlyGoal.toFixed(2);
                return;
            }

            state.settings.monthlyGoal = newGoal;

            // Persist settings changes
            saveState();
            renderUI();
        }


        window.showConfirmDelete = function() {
            vibrate(20);
            document.getElementById('delete-modal').classList.remove('hidden');
        }

        window.hideConfirmDelete = function() {
            vibrate(20);
            document.getElementById('delete-modal').classList.add('hidden');
        }

        window.deleteAllEntries = function() {
            vibrate(50);
            state.entries = [];
            state.timerStartTime = null; // Also reset running timer
            hideConfirmDelete();
            saveState();
            renderUI();
        }

        // --- FUNKCE PRO SPRÁVU KATEGORIÍ ---

        window.showCategoryManager = function() {
            vibrate(20);
            document.getElementById('category-modal').classList.remove('hidden');
            renderCategoryList();
        }
        window.hideCategoryManager = function() {
            vibrate(20);
            document.getElementById('category-modal').classList.add('hidden');
        }
        function renderCategoryList() {
            const listEl = document.getElementById('category-list');
            listEl.innerHTML = '';
            if (!state.settings.categories || state.settings.categories.length === 0) {
                listEl.innerHTML = '<p class="text-gray-500 text-center">Žádné kategorie.</p>';
                return;
            }
            // Třídění kategorií v seznamu
            [...state.settings.categories].sort().forEach(category => {
                const itemEl = document.createElement('div');
                itemEl.className = 'flex justify-between items-center bg-[#111827] p-3 rounded-lg large-touch-target';
                itemEl.innerHTML = `
                    <span class="text-gray-300">${category}</span>
                    <button class="text-red-500 hover:text-red-400 p-1 rounded-full" onclick="deleteCategory('${category.replace(/'/g, "\\'")}')">
                        <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 10-2 0v6a1 1 0 102 0V8z" clip-rule="evenodd" /></svg>
                    </button>
                `;
                listEl.appendChild(itemEl);
            });
        }
        window.addCategory = function() {
            vibrate(30);
            const input = document.getElementById('new-category-name');
            const newCategoryName = input.value.trim();
            
            if (!newCategoryName) return;
            
            const lowerCaseCategories = (state.settings.categories || []).map(c => c.toLowerCase());
            if (lowerCaseCategories.includes(newCategoryName.toLowerCase())) {
                console.warn("Kategorie již existuje.");
                input.value = '';
                return;
            }
            
            if (!Array.isArray(state.settings.categories)) {
                 state.settings.categories = [];
            }
            state.settings.categories.push(newCategoryName);
            
            saveState(); // Uloží nový stav kategorií
            renderCategoryList(); // Okamžitě překreslí seznam v modálu
            input.value = '';
            // `onSnapshot` se postará o překreslení zbytku UI (včetně dropdownů)
        }
        window.deleteCategory = function(categoryName) {
            vibrate(30);
            state.settings.categories = (state.settings.categories || []).filter(c => c !== categoryName);
            saveState(); // Uloží
            renderCategoryList(); // Překreslí modál
            // `onSnapshot` překreslí zbytek UI
        }

        // --- FUNKCE PRO ÚPRAVU ZÁZNAMŮ ---

        /**
         * Pomocná funkce pro formátování data do datetime-local vstupu (bere v úvahu časovou zónu)
         */
        function toLocalISOString(date) {
            const tzoffset = (new Date()).getTimezoneOffset() * 60000; //offset v milisekundách
            const localISOTime = (new Date(date - tzoffset)).toISOString().slice(0, 16);
            return localISOTime;
        }

        window.showEditModal = function(id) {
            vibrate(20);
            const entry = state.entries.find(e => e.id === id);
            if (!entry) return;

            // Uložíme ID
            document.getElementById('edit-entry-id').value = id;
            
            // Naplníme kategorie
            const categories = state.settings.categories || DEFAULT_CATEGORIES;
            const categorySelect = document.getElementById('edit-category');
            categorySelect.innerHTML = categories.map(c => `<option value="${c}">${c}</option>`).join('');
            // Pokud má záznam "archivní" kategorii, přidáme ji do seznamu
            if (!categories.includes(entry.category)) {
                categorySelect.innerHTML += `<option value="${entry.category}">${entry.category} (archivní)</option>`;
            }
            categorySelect.value = entry.category;

            // Zobrazíme správné pole podle typu
            const hourlyForm = document.getElementById('edit-form-hourly');
            const taskForm = document.getElementById('edit-form-task');
            if (entry.type === 'hourly') {
                hourlyForm.classList.remove('hidden');
                taskForm.classList.add('hidden');
                
                // Použijeme pomocnou funkci pro správný formát
                document.getElementById('edit-start-time').value = toLocalISOString(entry.startTime);
                if (entry.endTime) {
                    document.getElementById('edit-end-time').value = toLocalISOString(entry.endTime);
                }
            } else {
                // ZMĚNA: Nastavení dropdownu pro typ stolu
                hourlyForm.classList.add('hidden');
                taskForm.classList.remove('hidden');
                
                // Najdeme typ stolu podle výdělku
                let currentType = 'maly'; // default
                if (entry.taskEarnings === TASK_TYPES.stredni.earnings) {
                    currentType = 'stredni';
                } else if (entry.taskEarnings === TASK_TYPES.velky.earnings) {
                    currentType = 'velky';
                }
                document.getElementById('edit-task-type').value = currentType;
            }
            
            document.getElementById('edit-modal').classList.remove('hidden');
        }
        
        window.hideEditModal = function() {
            vibrate(20);
            document.getElementById('edit-modal').classList.add('hidden');
        }

        window.saveEntryChanges = function() {
            vibrate(50);
            const id = document.getElementById('edit-entry-id').value;
            const entryIndex = state.entries.findIndex(e => e.id === id);
            if (entryIndex === -1) return;
            
            const entry = { ...state.entries[entryIndex] }; // Vytvoříme kopii
            const newCategory = document.getElementById('edit-category').value;
            entry.category = newCategory;
            
            if (entry.type === 'hourly') {
                const newStartTimeStr = document.getElementById('edit-start-time').value;
                const newEndTimeStr = document.getElementById('edit-end-time').value;
                if (!newStartTimeStr || !newEndTimeStr) {
                    console.error("Musíte zadat začátek a konec.");
                    return;
                }
                const newStartTime = new Date(newStartTimeStr).getTime();
                const newEndTime = new Date(newEndTimeStr).getTime();
                
                if (newEndTime <= newStartTime) {
                    console.error("Čas konce musí být po čase začátku.");
                    return;
                }
                
                entry.startTime = newStartTime;
                entry.endTime = newEndTime;
                entry.duration = newEndTime - newStartTime;
                entry.timestamp = newEndTime; // Aktualizujeme timestamp pro třídění
            } else {
                // ZMĚNA: Uložení změn z dropdownu stolu
                const newType = document.getElementById('edit-task-type').value;
                const taskDetails = TASK_TYPES[newType];
                
                if (taskDetails) {
                    entry.taskName = taskDetails.name;
                    entry.taskEarnings = taskDetails.earnings;
                }
                // timestamp úkolu neměníme, aby zůstal na původním datu
            }

            state.entries[entryIndex] = entry; // Nahradíme starý záznam upraveným
            saveState(); // Uložíme celý stav
            hideEditModal();
            // `onSnapshot` se postará o překreslení
        }


        // --- UTILITY FUNCTIONS ---
        
        function formatDuration(ms) {
            const totalSeconds = Math.floor(ms / 1000);
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const seconds = totalSeconds % 60;
            return [hours, minutes, seconds].map(val => val.toString().padStart(2, '0')).join(':');
        }

        function formatDate(ts) {
            return new Date(ts).toLocaleDateString('cs-CZ', { day: 'numeric', month: 'short' });
        }

        function populateSelect(selectId, options, defaultValue = null) {
            const select = document.getElementById(selectId);
            select.innerHTML = options.map(opt => `<option value="${opt}">${opt}</option>`).join('');
            if (defaultValue) select.value = defaultValue;
        }

        function populateMonthFilter() {
            const select = document.getElementById('filter-month');
            const currentMonth = new Date().getMonth() + 1;
            select.innerHTML = MONTH_NAMES.map((name, idx) => {
                const monthNum = idx + 1;
                return `<option value="${monthNum}" ${monthNum === currentMonth ? 'selected' : ''}>${name}</option>`;
            }).join('');
        }

        function populateYearFilter() {
            const select = document.getElementById('filter-year');
            const currentYear = new Date().getFullYear();
            const years = [];
            for (let y = currentYear - 2; y <= currentYear + 1; y++) {
                years.push(y);
            }
            select.innerHTML = years.map(y => `<option value="${y}" ${y === currentYear ? 'selected' : ''}>${y}</option>`).join('');
        }

        function getFilteredEntries() {
            return state.entries.filter(e => {
                const entryDate = new Date(e.timestamp);
                const matchesMonth = (entryDate.getMonth() + 1) === state.filters.month && entryDate.getFullYear() === state.filters.year;
                const matchesType = state.filters.type === 'all' || e.type === state.filters.type;
                const matchesCategory = state.filters.category === 'all' || e.category === state.filters.category;
                return matchesType && matchesCategory && matchesMonth;
            }).sort((a, b) => b.timestamp - a.timestamp);
        }

        function updateTimerDisplay() {
            if (state.timerStartTime) {
                const elapsed = Date.now() - state.timerStartTime;
                document.getElementById('timer-display').textContent = formatDuration(elapsed);
                const statusSpan = document.getElementById('timer-status').firstElementChild;
                statusSpan.textContent = 'RUN';
                statusSpan.className = 'mr-2 text-green-400';
                document.getElementById('start-stop-button').textContent = 'UKONČIT PRÁCI';
            } else {
                document.getElementById('timer-display').textContent = '00:00:00';
                const statusSpan = document.getElementById('timer-status').firstElementChild;
                statusSpan.textContent = 'STOP';
                statusSpan.className = 'mr-2 text-yellow-400';
                document.getElementById('start-stop-button').textContent = 'ZAHÁJIT PRÁCI';
            }
        }

        function startTimerDisplay() {
            if (timerInterval) clearInterval(timerInterval);
            if (state.timerStartTime) {
                timerInterval = setInterval(() => {
                    updateTimerDisplay();
                    updateSummary();
                }, 1000);
            }
            updateTimerDisplay();
        }

        function updateCurrentSession() {
            const lastEntry = [...state.entries].sort((a, b) => b.timestamp - a.timestamp)[0];
            if (lastEntry && lastEntry.endTime) {
                const duration = formatDuration(lastEntry.duration);
                document.getElementById('current-session').textContent = `Poslední relace: ${lastEntry.category} - ${duration}`;
            } else {
                document.getElementById('current-session').textContent = 'Poslední relace: -';
            }
        }

        function updateSummary() {
            const currentMonth = new Date().getMonth() + 1;
            const currentYear = new Date().getFullYear();
            const monthEntries = state.entries.filter(e => {
                const dateToCheck = e.endTime || e.timestamp;
                const checkDate = new Date(dateToCheck);
                return checkDate.getMonth() + 1 === currentMonth && checkDate.getFullYear() === currentYear;
            });

            let totalEarnings = 0;
            let totalTime = 0;
            monthEntries.forEach(e => {
                let earn;
                if (e.type === 'hourly') {
                    const actualDuration = e.endTime ? e.duration : (Date.now() - e.startTime);
                    earn = (actualDuration / 3600000) * getUserRate();
                    totalTime += actualDuration;
                } else {
                    earn = e.taskEarnings || 0;
                }
                totalEarnings += earn;
            });

            totalTime = Math.floor(totalTime / 60000); // minutes

            const goal = state.settings.monthlyGoal;
            const progress = Math.min((totalEarnings / goal * 100), 100).toFixed(1);

            document.getElementById('total-earnings').textContent = totalEarnings.toFixed(2) + ' €';
            document.getElementById('goal-display').textContent = goal.toFixed(2) + ' €';
            document.getElementById('goal-progress').style.width = progress + '%';
            document.getElementById('goal-progress-text').textContent = progress + '% hotovo';
            document.getElementById('total-time').textContent = totalTime;
            document.getElementById('remaining-goal').textContent = (Math.max(goal - totalEarnings, 0)).toFixed(2) + ' €';

            // Update date display
            const now = new Date();
            document.getElementById('summary-date-display').textContent = `${MONTH_NAMES[now.getMonth()]} ${now.getFullYear()}`;
        }

        function renderEntries() {
            const filteredEntries = getFilteredEntries();
            const listEl = document.getElementById('entries-list');
            const noEntriesEl = document.getElementById('no-entries');

            if (filteredEntries.length === 0) {
                listEl.innerHTML = '';
                noEntriesEl.classList.remove('hidden');
                return;
            }

            noEntriesEl.classList.add('hidden');
            listEl.innerHTML = filteredEntries.map(entry => {
                let timeInfo, earnings;
                const category = entry.category;
                const dateStr = formatDate(entry.timestamp);
                const rate = getUserRate();

                if (entry.type === 'hourly') {
                    const actualDuration = entry.endTime ? entry.duration : (Date.now() - entry.startTime);
                    const durationStr = formatDuration(actualDuration);
                    earnings = (actualDuration / 3600000 * rate);
                    timeInfo = entry.endTime ? durationStr : `${durationStr} (běží)`;
                } else {
                    earnings = entry.taskEarnings || 0;
                    timeInfo = entry.taskName;
                }

                const totalEarnStr = earnings.toFixed(2);
                return `
                    <div class="bg-[#111827] p-4 rounded-xl border-l-4 border-indigo-500 large-touch-target">
                        <div class="flex justify-between items-start mb-2">
                            <div>
                                <h3 class="font-bold text-lg">${category}</h3>
                                <p class="text-sm text-gray-400">${dateStr}</p>
                            </div>
                            <div class="text-right">
                                <p class="text-2xl font-bold text-green-400">${totalEarnStr} €</p>
                                <p class="text-sm text-gray-500">${timeInfo}</p>
                            </div>
                        </div>
                        <div class="flex justify-end space-x-2">
                            <button class="text-blue-400 hover:text-blue-300 text-sm" onclick="showEditModal('${entry.id}')">Upravit</button>
                            <button class="text-red-400 hover:text-red-300 text-sm" onclick="deleteEntry('${entry.id}')">Smazat</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        window.updateFilters = function() {
            const month = parseInt(document.getElementById('filter-month').value);
            const year = parseInt(document.getElementById('filter-year').value);
            const typeFilter = document.getElementById('filter-type').value;
            const categoryFilter = document.getElementById('filter-category').value;

            state.filters = { month, year, type: typeFilter, category: categoryFilter };
            renderEntries();
        }

        window.exportToCSV = function() {
            vibrate(30);
            const allEntries = state.entries;
            if (allEntries.length === 0) {
                alert('Žádné záznamy k exportu.');
                return;
            }

            let csv = 'Datum,Kategorie,Typ,Čas/Úkol,Výdělek (€)\n';
            const rate = getUserRate();
            allEntries.forEach(e => {
                const date = new Date(e.timestamp).toLocaleDateString('cs-CZ');
                let type, detail, earn;
                if (e.type === 'hourly') {
                    type = 'Hodinová';
                    detail = formatDuration(e.duration);
                    earn = ((e.duration / 3600000) * rate).toFixed(2);
                } else {
                    type = 'Úkolová';
                    detail = e.taskName;
                    earn = (e.taskEarnings || 0).toFixed(2);
                }
                csv += `"${date}","${e.category}","${type}","${detail}","${earn}"\n`;
            });

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `worktime_${new Date().toISOString().slice(0, 10)}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function renderUI() {
            const categories = state.settings.categories || DEFAULT_CATEGORIES;
            populateSelect('entry-category', categories);
            populateSelect('filter-category', ['all', ...categories]);

            document.getElementById('hourly-rate').value = getUserRate().toFixed(2);
            document.getElementById('monthly-goal').value = state.settings.monthlyGoal.toFixed(2);

            populateMonthFilter();
            populateYearFilter();

            updateTimerDisplay();
            updateSummary();
            updateCurrentSession();
            renderEntries();
        }

        // Initialize on load
        window.addEventListener('load', initAuth);
    </script>
</body>
</html>
```

Zdroje
