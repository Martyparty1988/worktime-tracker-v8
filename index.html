<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
    <title>WorkTime Tracker v7.1 (€) - Stoly</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0c0d12;
            color: #e5e7eb;
        }
        .app-container {
            max-width: 450px;
        }
        .glow-main {
            box-shadow: 0 0 10px rgba(79, 70, 229, 0.3);
        }
        .btn-primary {
            background-color: #4f46e5;
            color: #ffffff;
            font-weight: 700;
            transition: all 0.2s;
        }
        .btn-primary:hover {
            background-color: #4338ca;
        }
        .btn-primary:active {
            transform: scale(0.98);
        }
        .btn-secondary {
            background-color: #1f2937;
            border: 1px solid #374151;
            color: #d1d5db;
            transition: background-color 0.2s;
        }
        .btn-secondary:hover {
            background-color: #374151;
        }
        input[type='text'],
        input[type='number'],
        input[type='datetime-local'],
        select {
            background-color: #1f2937;
            border: 1px solid #374151;
            color: #e5e7eb;
            padding: 10px 14px;
            border-radius: 8px;
            transition: border-color 0.2s;
        }
        input:focus,
        select:focus {
            border-color: #4f46e5;
            outline: none;
            box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.5);
        }
        input[type='datetime-local']::-webkit-calendar-picker-indicator {
            background-color: #9ca3af;
            border-radius: 2px;
        }
        .tab-active {
            background-color: #1f2937;
            border-bottom: 2px solid #4f46e5;
            color: #e5e7eb;
        }
        .large-touch-target {
            min-height: 48px;
        }
        .progress-bar {
            height: 10px;
            background-color: #374151;
            border-radius: 5px;
            overflow: hidden;
        }
        .progress-fill {
            background-color: #4f46e5;
            transition: width 0.5s ease-in-out;
        }
    </style>
</head>
<body class="p-4 flex justify-center large-touch-target">
    <div id="app" class="app-container w-full">
        <header class="mb-8 text-center">
            <h1 class="text-4xl font-extrabold text-[#4f46e5] glow-main large-touch-target">WorkTime v7.1</h1>
            <p class="text-sm text-gray-400">Sledování výkonu s kategoriemi a cíli | Měna: EUR (€)</p>
        </header>

        <div id="main-content">
            <section id="new-entry-form" class="bg-[#111827] p-5 rounded-2xl mb-8 shadow-2xl large-touch-target">
                <h2 class="text-2xl font-bold mb-4 border-b border-gray-700 pb-2">Nová Činnost</h2>
                <div class="flex large-touch-target mb-4 border border-gray-700 rounded-lg overflow-hidden">
                    <button id="tab-hourly" class="flex-1 py-3 text-sm font-semibold tab-active" onclick="switchEntryType('hourly')">Hodinová Práce</button>
                    <button id="tab-task" class="flex-1 py-3 text-sm font-semibold" onclick="switchEntryType('task')">Úkolová Práce</button>
                </div>
                <div class="mb-4">
                    <label for="entry-category" class="block text-sm font-medium mb-1 text-gray-400">Kategorie / Projekt:</label>
                    <select id="entry-category" class="w-full large-touch-target"></select>
                </div>
                <div id="form-hourly">
                    <div class="flex justify-between items-center mb-4 p-3 bg-gray-800 rounded-lg">
                        <span class="text-sm font-medium text-gray-400">Stav:</span>
                        <div id="timer-status" class="flex items-center text-2xl font-mono font-bold">
                            <span class="mr-2 text-yellow-400">STOP</span>
                            <span id="timer-display">00:00:00</span>
                        </div>
                    </div>
                    <button id="start-stop-button" class="w-full large-touch-target py-3 rounded-xl btn-primary mb-3 shadow-lg" onclick="toggleTimer()">ZAHÁJIT PRÁCI</button>
                    <p id="current-session" class="text-xs text-gray-500 text-center">Poslední relace: -</p>
                </div>
                <div id="form-task" class="hidden space-y-4">
                    <div>
                        <label for="task-type" class="block text-sm font-medium mb-1 text-gray-400">Typ Stolu:</label>
                        <select id="task-type" class="w-full large-touch-target">
                            <option value="maly">Malý stůl (30 €)</option>
                            <option value="stredni">Střední stůl (48 €)</option>
                            <option value="velky">Velký stůl (60 €)</option>
                        </select>
                    </div>
                    <button class="w-full large-touch-target py-3 rounded-xl btn-primary shadow-lg" onclick="saveTaskEntry()">ULOŽIT ÚKOL</button>
                </div>
            </section>

            <section class="bg-[#1f2937] p-5 rounded-2xl mb-8 shadow-xl large-touch-target">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold">Přehled</h2>
                    <span id="summary-date-display" class="text-sm font-semibold text-indigo-400">Leden 2025</span>
                </div>
                <div class="flex justify-between items-end mb-4 border-b border-gray-700 pb-3">
                    <span class="text-gray-400 text-sm">Výdělek (vč. běžícího):</span>
                    <span id="total-earnings" class="text-3xl font-extrabold text-[#818cf8] font-mono">0.00 €</span>
                </div>
                <div class="space-y-3">
                    <div class="flex justify-between text-sm font-semibold">
                        <span class="text-gray-400">Měsíční Cíl (€):</span>
                        <span id="goal-display" class="text-indigo-400">500.00 €</span>
                    </div>
                    <div class="progress-bar">
                        <div id="goal-progress" class="progress-fill h-full" style="width: 0%;"></div>
                    </div>
                    <p id="goal-progress-text" class="text-sm text-center text-gray-400">0% hotovo</p>
                </div>
                <div class="flex justify-between mt-4">
                    <div class="text-center">
                        <p class="text-gray-500 text-xs">Celkem Času (min):</p>
                        <p id="total-time" class="font-bold text-lg text-green-400">0</p>
                    </div>
                    <div class="text-center">
                        <p class="text-gray-500 text-xs">Zbývá do Cíle (€):</p>
                        <p id="remaining-goal" class="font-bold text-lg text-red-400">500.00 €</p>
                    </div>
                </div>
            </section>

            <section class="mb-8">
                <h2 class="text-2xl font-bold mb-4">Záznamy <span id="user-display" class="text-sm text-gray-500"></span></h2>
                <div class="grid grid-cols-2 gap-2 mb-4">
                    <select id="filter-month" class="w-full py-2 text-sm large-touch-target" onchange="updateFilters()"></select>
                    <select id="filter-year" class="w-full py-2 text-sm large-touch-target" onchange="updateFilters()"></select>
                    <select id="filter-type" class="w-full py-2 text-sm large-touch-target" onchange="updateFilters()">
                        <option value="all">Typ: Vše</option>
                        <option value="hourly">Typ: Hodinová</option>
                        <option value="task">Typ: Úkolová</option>
                    </select>
                    <select id="filter-category" class="w-full py-2 text-sm large-touch-target" onchange="updateFilters()">
                        <option value="all">Projekt: Vše</option>
                    </select>
                </div>
                <div id="entries-list" class="space-y-3">
                    <p id="no-entries" class="text-gray-500 text-center p-4 large-touch-target">Žádné záznamy k zobrazení.</p>
                </div>
            </section>

            <section class="bg-[#111827] p-5 rounded-2xl mb-6 shadow-xl large-touch-target">
                <h2 class="text-xl font-bold mb-4 border-b border-gray-700 pb-2">Nastavení</h2>
                <div class="mb-4">
                    <label for="hourly-rate" class="block text-sm font-medium mb-1 text-gray-400">Hodinová Sazba (€/h):</label>
                    <div class="flex space-x-2">
                        <input type="number" id="hourly-rate" value="10.00" min="1" step="0.01" class="flex-1 rounded-lg large-touch-target" />
                        <button class="py-2 px-4 rounded-lg btn-secondary large-touch-target" onclick="saveRate()">Uložit</button>
                    </div>
                </div>
                <div class="mb-6">
                    <label for="monthly-goal" class="block text-sm font-medium mb-1 text-gray-400">Měsíční Cíl (€):</label>
                    <div class="flex space-x-2">
                        <input type="number" id="monthly-goal" value="500.00" min="1" step="1" class="flex-1 rounded-lg large-touch-target" />
                        <button class="py-2 px-4 rounded-lg btn-secondary large-touch-target" onclick="saveGoal()">Uložit</button>
                    </div>
                </div>
                <div class="space-y-3 pt-4 border-t border-gray-700">
                    <button class="w-full py-2 rounded-lg btn-secondary large-touch-target" onclick="showCategoryManager()">Správa Kategorií</button>
                    <button class="w-full py-2 rounded-lg btn-secondary large-touch-target" onclick="exportToCSV()">Exportovat do CSV</button>
                    <button class="w-full py-2 rounded-lg bg-red-800 hover:bg-red-700 text-white font-bold large-touch-target" onclick="showConfirmDelete()">Smazat Všechny Záznamy</button>
                </div>
            </section>
        </div>

        <div id="delete-modal" class="fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center p-4 hidden z-50">
            <div class="bg-[#1f2937] p-6 rounded-xl shadow-2xl w-full max-w-sm border border-gray-700">
                <h3 class="text-xl font-bold mb-4 text-red-400">Potvrdit Smazání</h3>
                <p class="mb-6 text-gray-300">Opravdu chcete smazat VŠECHNY záznamy? Tato akce je nevratná.</p>
                <div class="flex justify-end space-x-3">
                    <button class="py-2 px-4 rounded-lg btn-secondary large-touch-target" onclick="hideConfirmDelete()">Zrušit</button>
                    <button class="py-2 px-4 rounded-lg bg-red-600 hover:bg-red-700 text-white font-bold large-touch-target" onclick="deleteAllEntries()">Smazat</button>
                </div>
            </div>
        </div>

        <div id="category-modal" class="fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center p-4 hidden z-50">
            <div class="bg-[#1f2937] p-6 rounded-xl shadow-2xl w-full max-w-sm border border-gray-700">
                <h3 class="text-xl font-bold mb-4 text-indigo-400">Správa Kategorií</h3>
                <div class="flex space-x-2 mb-4">
                    <input type="text" id="new-category-name" placeholder="Nový projekt/kategorie" class="flex-1 large-touch-target" />
                    <button class="py-2 px-4 rounded-lg btn-primary large-touch-target" onclick="addCategory()">Přidat</button>
                </div>
                <div class="space-y-2 max-h-60 overflow-y-auto" id="category-list"></div>
                <div class="flex justify-end mt-6">
                    <button class="py-2 px-4 rounded-lg btn-secondary large-touch-target" onclick="hideCategoryManager()">Zavřít</button>
                </div>
            </div>
        </div>

        <div id="edit-modal" class="fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center p-4 hidden z-50">
            <div class="bg-[#1f2937] p-6 rounded-xl shadow-2xl w-full max-w-sm border border-gray-700">
                <h3 class="text-xl font-bold mb-4 text-indigo-400">Upravit Záznam</h3>
                <input type="hidden" id="edit-entry-id" />
                <div class="space-y-4">
                    <div>
                        <label for="edit-category" class="block text-sm font-medium mb-1 text-gray-400">Kategorie / Projekt:</label>
                        <select id="edit-category" class="w-full large-touch-target"></select>
                    </div>
                    <div id="edit-form-hourly" class="space-y-4">
                        <div>
                            <label for="edit-start-time" class="block text-sm font-medium mb-1 text-gray-400">Začátek:</label>
                            <input type="datetime-local" id="edit-start-time" class="w-full large-touch-target" />
                        </div>
                        <div>
                            <label for="edit-end-time" class="block text-sm font-medium mb-1 text-gray-400">Konec:</label>
                            <input type="datetime-local" id="edit-end-time" class="w-full large-touch-target" />
                        </div>
                    </div>
                    <div id="edit-form-task" class="space-y-4 hidden">
                        <div>
                            <label for="edit-task-type" class="block text-sm font-medium mb-1 text-gray-400">Typ Stolu:</label>
                            <select id="edit-task-type" class="w-full large-touch-target">
                                <option value="maly">Malý stůl (30 €)</option>
                                <option value="stredni">Střední stůl (48 €)</option>
                                <option value="velky">Velký stůl (60 €)</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="flex justify-end space-x-3 mt-6">
                    <button class="py-2 px-4 rounded-lg btn-secondary large-touch-target" onclick="hideEditModal()">Zrušit</button>
                    <button class="py-2 px-4 rounded-lg btn-primary large-touch-target" onclick="saveEntryChanges()">Uložit Změny</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const DEFAULT_RATE_EUR = 15.0;
        const DEFAULT_GOAL_EUR = 500.0;
        const DEFAULT_CATEGORIES = ['Design', 'Vývoj', 'Schůzky', 'Administrativa', 'Osobní'];
        const MONTH_NAMES = [
            'Leden',
            'Únor',
            'Březen',
            'Duben',
            'Květen',
            'Červen',
            'Červenec',
            'Srpen',
            'Září',
            'Říjen',
            'Listopad',
            'Prosinec',
        ];
        const TASK_TYPES = {
            maly: { name: 'Malý stůl', earnings: 30 },
            stredni: { name: 'Střední stůl', earnings: 48 },
            velky: { name: 'Velký stůl', earnings: 60 },
        };

        let state = {
            timerStartTime: null,
            entries: [],
            settings: {
                userRates: {},
                monthlyGoal: DEFAULT_GOAL_EUR,
                categories: DEFAULT_CATEGORIES,
            },
            entryType: 'hourly',
            filters: {
                type: 'all',
                category: 'all',
                month: new Date().getMonth() + 1,
                year: new Date().getFullYear(),
            },
        };

        let timerInterval = null;

        function saveState() {
            try {
                const dataToSave = {
                    entries: state.entries,
                    settings: state.settings,
                    timerStartTime: state.timerStartTime,
                };
                localStorage.setItem('worktime-tracker-data', JSON.stringify(dataToSave));
            } catch (error) {
                console.error('Chyba při ukládání do localStorage:', error);
            }
        }

        function loadState() {
            try {
                const savedData = localStorage.getItem('worktime-tracker-data');
                if (savedData) {
                    const data = JSON.parse(savedData);
                    state.entries = data.entries || [];
                    state.settings = data.settings || {
                        userRates: {},
                        monthlyGoal: DEFAULT_GOAL_EUR,
                        categories: DEFAULT_CATEGORIES,
                    };
                    state.timerStartTime = data.timerStartTime || null;
                }
            } catch (error) {
                console.error('Chyba při načítání z localStorage:', error);
            }
        }

        function vibrate(duration = 10) {
            if ('vibrate' in navigator) {
                navigator.vibrate(duration);
            }
        }

        function switchEntryType(type) {
            vibrate();
            state.entryType = type;
            const hourlyForm = document.getElementById('form-hourly');
            const taskForm = document.getElementById('form-task');
            const tabHourly = document.getElementById('tab-hourly');
            const tabTask = document.getElementById('tab-task');

            tabHourly.classList.remove('tab-active');
            tabTask.classList.remove('tab-active');

            if (type === 'hourly') {
                hourlyForm.classList.remove('hidden');
                taskForm.classList.add('hidden');
                tabHourly.classList.add('tab-active');
            } else {
                hourlyForm.classList.add('hidden');
                taskForm.classList.remove('hidden');
                tabTask.classList.add('tab-active');
            }
        }

        function getUserRate() {
            return state.settings.userRates['default'] || DEFAULT_RATE_EUR;
        }

       function toggleTimer() {
    vibrate(50);
    const selectedCategory = document.getElementById('entry-category').value;

    // Zkontrolujeme, zda je vybrána kategorie
    if (!selectedCategory && !state.timerStartTime) {
        console.error("Vyberte prosím kategorii před zahájením práce.");
        const categorySelect = document.getElementById('entry-category');
        categorySelect.classList.add('border-red-500', 'animate-pulse');
        setTimeout(() => categorySelect.classList.remove('border-red-500', 'animate-pulse'), 1000);
        return;
    }

    if (state.timerStartTime) {
        // Stop the timer
        const now = Date.now();
        const duration = now - state.timerStartTime;

        // Najdeme běžící záznam podle startTime a endTime null
        const runningEntryIndex = state.entries.findIndex(
            (e) => e.startTime === state.timerStartTime && e.endTime === null
        );

        if (runningEntryIndex !== -1) {
            state.entries[runningEntryIndex].endTime = now;
            state.entries[runningEntryIndex].duration = duration;
            state.entries[runningEntryIndex].timestamp = now;
        } else {
            // Pokud není nalezen žádný běžící záznam (zalomit by se nemělo)
            state.entries.push({
                id: crypto.randomUUID(),
                type: 'hourly',
                category: selectedCategory,
                startTime: state.timerStartTime,
                endTime: now,
                duration: duration,
                timestamp: now,
            });
        }

        state.timerStartTime = null;
        if (timerInterval) {
            clearInterval(timerInterval);
            timerInterval = null;
        }
    } else {
        // Start the timer
        state.timerStartTime = Date.now();

        // Přidáme dočasný záznam běžící hodiny
        state.entries.push({
            id: crypto.randomUUID(),
            type: 'hourly',
            category: selectedCategory,
            startTime: state.timerStartTime,
            endTime: null,
            duration: 0,
            timestamp: state.timerStartTime,
        });

        startTimerDisplay();
    }
    saveState();
    renderUI();
}

// Funkce pro spuštění a aktualizaci časovače na UI
function startTimerDisplay() {
    if (timerInterval) clearInterval(timerInterval);
    if (!state.timerStartTime) {
        updateTimerDisplay(0);
        return;
    }
    timerInterval = setInterval(() => {
        const elapsed = Date.now() - state.timerStartTime;
        updateTimerDisplay(elapsed);
    }, 1000);
}

function updateTimerDisplay(ms) {
    const display = document.getElementById('timer-display');
    display.textContent = formatDuration(ms);
    const status = document.getElementById('timer-status').children[0];
    const startStopBtn = document.getElementById('start-stop-button');
    if (state.timerStartTime) {
        status.textContent = 'RUN';
        status.classList.remove('text-yellow-400');
        status.classList.add('text-green-400');
        startStopBtn.textContent = 'ZASTAVIT PRÁCI';
    } else {
        status.textContent = 'STOP';
        status.classList.remove('text-green-400');
        status.classList.add('text-yellow-400');
        startStopBtn.textContent = 'ZAHÁJIT PRÁCI';
    }
}

function formatDuration(ms) {
    const totalSeconds = Math.floor(ms / 1000);
    const hours = Math.floor(totalSeconds / 3600)
        .toString()
        .padStart(2, '0');
    const minutes = Math.floor((totalSeconds % 3600) / 60)
        .toString()
        .padStart(2, '0');
    const seconds = (totalSeconds % 60).toString().padStart(2, '0');
    return `${hours}:${minutes}:${seconds}`;
}

// Další potřebné funkce (renderUI, uložit úkol, správa kategorií aj.) by následovaly zde

// Počáteční inicializace
window.onload = () => {
    loadState();
    initUI();
    renderUI();
    if(state.timerStartTime) startTimerDisplay();
};

// Inicializace UI elementů jako selecty měsíců, roků, kategorií
function initUI() {
    // Naplnění výběru měsíců
    const filterMonth = document.getElementById('filter-month');
    MONTH_NAMES.forEach((monthName, i) => {
        const option = document.createElement('option');
        option.value = i + 1;
        option.textContent = monthName;
        filterMonth.appendChild(option);
    });
    filterMonth.value = state.filters.month;

    // Naplnění výběru roků (např. posledních 5 let)
    const filterYear = document.getElementById('filter-year');
    const currentYear = new Date().getFullYear();
    for (let y = currentYear; y >= currentYear - 5; y--) {
        const option = document.createElement('option');
        option.value = y;
        option.textContent = y;
        filterYear.appendChild(option);
    }
    filterYear.value = state.filters.year;

    // Naplnění kategorií
    renderCategoryOptions();
}

// Nastavení kategorií v selectu
function renderCategoryOptions() {
    const categorySelects = [
        document.getElementById('entry-category'),
        document.getElementById('filter-category'),
        document.getElementById('edit-category'),
    ];
    categorySelects.forEach((select) => {
        select.innerHTML = '<option value="all">Vše</option>';
        state.settings.categories.forEach((cat) => {
            const option = document.createElement('option');
            option.value = cat;
            option.textContent = cat;
            select.appendChild(option);
        });
    });
    document.getElementById('filter-category').value = state.filters.category;
}

// Render UI, seznam záznamů, přehledy atd.
// Funkce renderUI, updateFilters, saveRate, saveGoal, saveTaskEntry, deleteEntry atd. ještě doplnit...

